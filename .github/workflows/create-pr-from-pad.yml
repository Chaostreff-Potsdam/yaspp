name: Create PR from Pad Entry

on:
  workflow_dispatch: # This event triggers the workflow manually
    inputs:
      max_new_entries:
        description: 'Maximum number of new entries to process'
        required: false
        default: '1'
        type: string
      file_base_url:
        description: 'Base URL for sound files'
        required: false
        default: 'https://radio.ccc-p.org/files'
        type: string

jobs:
  parse_pad_and_create_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@main

      - name: Set up Go
        uses: actions/setup-go@main
        with:
          go-version: '1.21'

      - name: Parse Pad Entry and append to content.yaml
        id: go-run
        working-directory: ./pad2gh
        run: go run ./ -c ../pr-comments.md -o ../content.yaml -bulk -max-new-entries=${{ inputs.max_new_entries }} -file-online -file-base-url=${{ inputs.file_base_url }} -strict -continue-on-error >> $GITHUB_OUTPUT # only prints the entry date and collects it in the output, stderr is not captured and will show in the log

      - name: Generate GitHub App token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.CIR_BOT_APP_ID }}
          private_key: ${{ secrets.CIR_BOT_APP_PRIVATE_KEY }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@main
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: 'Add episode ${{ steps.go-run.outputs.entrydate }} from Pad'
          title: 'Add episode ${{ steps.go-run.outputs.entrydate }} from Pad'
          body-path: pr-comments.md
          add-paths: content.yaml
          branch: "cir-bot/episode-${{ steps.go-run.outputs.entrydate }} "
          base: ${{ github.ref_name }}